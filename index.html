<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-09-11 Sun 19:10 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Google Summer of Code Final Report</title>
<meta name="author" content="Zarak Mahmud" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<style>pre.src{background:#343131;color:white;} </style>
<style>pre.src:hover:before {display: inline; margin-top: 0px;} </style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Google Summer of Code Final Report</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org655f547">1. Overview</a></li>
<li><a href="#orgba9d787">2. Working Period</a>
<ul>
<li><a href="#orge7a19e2">2.1. Developer setup</a></li>
<li><a href="#org85b5d81">2.2. Goal Core</a>
<ul>
<li><a href="#orgbbe05cf">2.2.1. Test suite</a></li>
</ul>
</li>
<li><a href="#org7a17b4e">2.3. Goal Geometry</a>
<ul>
<li><a href="#org8c31ca8">2.3.1. Runtime exceptions</a></li>
<li><a href="#org98517d7">2.3.2. Benchmarks</a></li>
<li><a href="#org84dbab7">2.3.3. Profiling</a></li>
</ul>
</li>
<li><a href="#org52df0ea">2.4. Goal Probability</a>
<ul>
<li><a href="#org4fa9587">2.4.1. Random tensors</a></li>
<li><a href="#org70ac2ff">2.4.2. Runtime exceptions</a></li>
<li><a href="#org3bab85a">2.4.3. Benchmarks</a></li>
<li><a href="#org4cb3430">2.4.4. Profiling</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf115300">3. Future Work</a></li>
</ul>
</div>
</div>

<div id="outline-container-org655f547" class="outline-2">
<h2 id="org655f547"><span class="section-number-2">1.</span> Overview</h2>
<div class="outline-text-2" id="text-1">

<div id="org214a3b7" class="figure">
<p><img src="./haskell-logo.svg" alt="haskell-logo.svg" class="org-svg" />
</p>
</div>

<p>
This is the final report for a <a href="https://summerofcode.withgoogle.com/programs/2022/projects/4WYrEknl">proposal</a> in the Haskell organization to enhance the <code>Goal</code> library with GPU operations. All commits were made to the <a href="https://gitlab.com/sacha-sokoloski/goal/-/tree/experimental">experimental branch</a>.
</p>
</div>
</div>

<div id="outline-container-orgba9d787" class="outline-2">
<h2 id="orgba9d787"><span class="section-number-2">2.</span> Working Period</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orge7a19e2" class="outline-3">
<h3 id="orge7a19e2"><span class="section-number-3">2.1.</span> Developer setup</h3>
<div class="outline-text-3" id="text-2-1">
<p>
I originally planned to create a nix shell for development. During the proposal period I experimented with Hasktorch and Goal using a nix <a href="https://github.com/zarak/glowing-train">template</a> provided by Hastorch. Ultimately, however, we settled on Docker for the dev environment, as it may be more straightforward to use with <a href="https://apptainer.org/">Apptainer</a> for HPC tasks. The final docker image clocked in at over 14 GB in size. I tried to reduce this but only managed to trim off about half a gigabyte.
</p>
<pre class="example">
zarak@nixos ~ ❯ docker history f71d81c4404d
IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT
f71d81c4404d   2 months ago   /bin/bash -c #(nop)  CMD ["/bin/bash"]          0B
153417880ada   2 months ago   /bin/bash -c #(nop)  ENV PATH=/usr/local/bin…   0B
116decd9c5a0   2 months ago   /bin/bash -c #(nop)  ENV NVIDIA_DRIVER_CAPAB…   0B
ea3546bf7926   2 months ago   /bin/bash -c #(nop)  ENV NVIDIA_VISIBLE_DEVI…   0B
c55774b975f8   2 months ago   |4 CABAL=latest DEBIAN_FRONTEND=noninteracti…   4.03GB
3e713b88518a   2 months ago   /bin/bash -c #(nop) COPY file:1642f81b2fc032…   1.22kB
b354f7d1e1be   2 months ago   |4 CABAL=latest DEBIAN_FRONTEND=noninteracti…   66.9kB
bee356d14e95   2 months ago   /bin/bash -c #(nop)  SHELL [/bin/bash -c]       0B
8bb54779d991   2 months ago   |4 CABAL=latest DEBIAN_FRONTEND=noninteracti…   20MB
1a9db6f64989   2 months ago   |4 CABAL=latest DEBIAN_FRONTEND=noninteracti…   3.8GB
7009ce892ba2   2 months ago   |4 CABAL=latest DEBIAN_FRONTEND=noninteracti…   4.78GB
1c62275ed751   2 months ago   /bin/sh -c #(nop)  ARG CABAL=latest             0B
231a648e7653   2 months ago   /bin/sh -c #(nop)  ARG GHC=9.0.2                0B
a8e5be427c4f   2 months ago   |2 DEBIAN_FRONTEND=noninteractive GPG_KEY=77…   15.4MB
6be00d62872f   2 months ago   |2 DEBIAN_FRONTEND=noninteractive GPG_KEY=77…   3.29kB
01c26ac2d371   2 months ago   /bin/sh -c #(nop)  ARG GPG_KEY=7784930957807…   0B
9db92454b75e   2 months ago   |1 DEBIAN_FRONTEND=noninteractive /bin/sh -c…   1.54GB
6f33782b4774   2 months ago   /bin/sh -c #(nop)  ENV BLAS=OpenBlas            0B
56468c103876   2 months ago   /bin/sh -c #(nop)  ENV TZ=Europe/Berlin         0B
1f2add153ab6   2 months ago   /bin/sh -c #(nop)  ARG DEBIAN_FRONTEND=nonin…   0B
20fffa419e3a   3 months ago   /bin/sh -c #(nop)  CMD ["bash"]                 0B
&lt;missing&gt;      3 months ago   /bin/sh -c #(nop) ADD file:00dae10e79b05c4e1…   72.8MB
</pre>
<p>
This docker image does not cache the Hasktorch library build artifacts, which means that I have to rebuild all of Hasktorch each time I run a fresh instance of the container. Another slight annoyance occurred if I left the container running and my system was suspended; libtorch would occasionally stop detecting the GPU, which necessitated a container restart and hence rebuild. Rather than spend time tackling all these issues, however, I proceeded with the primary objective of the project.
</p>
</div>
</div>
<div id="outline-container-org85b5d81" class="outline-3">
<h3 id="org85b5d81"><span class="section-number-3">2.2.</span> Goal Core</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Core primarily contains functions that are thin wrappers around their Hasktorch counterparts in <a href="https://gitlab.com/sacha-sokoloski/goal/-/blob/b6fa159574f2fc67481e046b537b0cffe222d8d9/core/Goal/Core/Hasktorch/Vector.hs">Vector.hs</a>. If a required function was not provided by Hasktorch, I wrote it using Hasktorch primitives.
</p>

<p>
For example, <code>scale</code> is a thin wrapper around Hasktorch&rsquo;s <code>mulScale</code> function:
</p>
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #87ceeb;">scale</span> <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Scalar</span> x <span style="color: #c7c9cb;">=&gt;</span> x <span style="color: #c7c9cb;">-&gt;</span> <span style="color: #b877db;">Vector</span> n a d <span style="color: #c7c9cb;">-&gt;</span> <span style="color: #b877db;">Vector</span> n a d
<span style="color: #87ceeb; font-weight: bold;">{-# INLINE scale  #-}</span>
<span style="color: #87ceeb;">scale</span> x <span style="color: #c7c9cb;">=</span> <span style="color: #fab795;">UnsafeVector</span> <span style="color: #c7c9cb;">.</span> mulScalar x <span style="color: #c7c9cb;">.</span> toTorch
</pre>
</div>

<p>
On the other hand, I used <code>einsum</code> to implement <a href="https://gitlab.com/sacha-sokoloski/goal/-/blob/b6fa159574f2fc67481e046b537b0cffe222d8d9/core/Goal/Core/Hasktorch/Vector.hs#L481-488">a function to compute the outer product</a>, as this was not available natively in Hasktorch:
</p>
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #87ceeb;">outerProduct</span>
    <span style="color: #c7c9cb;">::</span> (<span style="color: #b877db;">KnownNat</span> m, <span style="color: #b877db;">KnownNat</span> n, <span style="color: #b877db;">Num</span> x)
    <span style="color: #c7c9cb;">=&gt;</span> <span style="color: #b877db;">Vector</span> m x d
    <span style="color: #c7c9cb;">-&gt;</span> <span style="color: #b877db;">Vector</span> n x d
    <span style="color: #c7c9cb;">-&gt;</span> <span style="color: #b877db;">Matrix</span> m n x d
<span style="color: #87ceeb; font-weight: bold;">{-# INLINE outerProduct #-}</span>
<span style="color: #87ceeb;">outerProduct</span> v1 v2 <span style="color: #c7c9cb;">=</span>
    <span style="color: #fab795;">Matrix</span> <span style="color: #c7c9cb;">$</span> <span style="color: #fab795;">UnsafeVector</span> <span style="color: #c7c9cb;">$</span> flattenAll <span style="color: #c7c9cb;">$</span> einsum <span style="color: #fab795;">"i,j-&gt;ij"</span> [toTorch v1, toTorch v2]
</pre>
</div>

<p>
Another example is <code>matrixRoot</code>, which I implemented by referring to the <code>hmatrix</code> source code:
</p>
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #fab795; font-style: italic;">-- | Computes the square root of a 'Matrix' using Denman-Beavers iteration.</span>
<span style="color: #fab795; font-style: italic;">-- A slightly modified version of the [implementation](https:</span><span style="color: #fab795; font-style: italic;">//</span><span style="color: #fab795; font-style: italic;">hackage.haskell.org</span><span style="color: #fab795; font-style: italic;">/package/</span><span style="color: #fab795; font-style: italic;">hmatrix-0.20.2</span><span style="color: #fab795; font-style: italic;">/docs/</span><span style="color: #fab795; font-style: italic;">src/Internal.Algorithms.html#sqrtmInv) in hmatrix-0.20.2.</span>
<span style="color: #87ceeb;">matrixRoot</span>
    <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">forall</span> n x d<span style="color: #c7c9cb;">.</span> (<span style="color: #b877db;">KnownNat</span> n, <span style="color: #b877db;">Num</span> x, <span style="color: #b877db;">Scalar</span> x, <span style="color: #b877db;">HasTensorOptions</span> x d)
    <span style="color: #c7c9cb;">=&gt;</span> <span style="color: #b877db;">Matrix</span> n n x d
    <span style="color: #c7c9cb;">-&gt;</span> <span style="color: #b877db;">Matrix</span> n n x d
<span style="color: #87ceeb; font-weight: bold;">{-# INLINE matrixRoot #-}</span>
<span style="color: #87ceeb;">matrixRoot</span> mtx <span style="color: #c7c9cb;">=</span> <span style="color: #fab795;">Matrix</span> <span style="color: #c7c9cb;">$</span> <span style="color: #fab795;">UnsafeVector</span> <span style="color: #c7c9cb;">$</span> flattenAll <span style="color: #c7c9cb;">$</span> fst <span style="color: #c7c9cb;">$</span> fixedPoint <span style="color: #c7c9cb;">$</span> iterate f (t, eyeSquare n opts)
    <span style="color: #b877db;">where</span> n <span style="color: #c7c9cb;">=</span> natValInt (<span style="color: #fab795;">Proxy</span> <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Proxy</span> n)
          opts <span style="color: #c7c9cb;">=</span> tensorOpts (<span style="color: #fab795;">Proxy</span> <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Proxy</span> x) (<span style="color: #fab795;">Proxy</span> <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Proxy</span> d)
          f (y, z) <span style="color: #c7c9cb;">=</span> (<span style="color: #f09383; font-weight: bold;">0.5</span> <span style="color: #c7c9cb;">*</span> (y <span style="color: #c7c9cb;">+</span> Torch.inverse z),
                      <span style="color: #f09383; font-weight: bold;">0.5</span> <span style="color: #c7c9cb;">*</span> (Torch.inverse y <span style="color: #c7c9cb;">+</span> z))
          t <span style="color: #c7c9cb;">=</span> reshape [n, n] <span style="color: #c7c9cb;">$</span> toTorch <span style="color: #c7c9cb;">$</span> toVector mtx
          fixedPoint (a<span style="color: #fab795;">:</span>b<span style="color: #fab795;">:</span>rest) <span style="color: #c7c9cb;">|</span> asValue <span style="color: #c7c9cb;">$</span> le (l1Loss <span style="color: #fab795;">ReduceMean</span> (fst a) (fst b)) peps <span style="color: #c7c9cb;">=</span> a
                                <span style="color: #c7c9cb;">|</span> otherwise <span style="color: #c7c9cb;">=</span> fixedPoint (b<span style="color: #fab795;">:</span>rest)
          fixedPoint <span style="color: #b877db;">_</span> <span style="color: #c7c9cb;">=</span> error <span style="color: #fab795;">"fixed point with impossible inputs"</span>
</pre>
</div>
<p>
Unlike in the <code>hmatrix</code> version, however, when checking for convergence, I took the mean when computing the l1 norm rather than the sum of the absolute values because I sometimes failed to achieve convergence (even though I theoretically should have) using the latter reduction. This function wasn&rsquo;t critical within the scope of this project so rather than investigating further I moved on.
</p>
</div>

<div id="outline-container-orgbbe05cf" class="outline-4">
<h4 id="orgbbe05cf"><span class="section-number-4">2.2.1.</span> Test suite</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
I wrote a <a href="https://gitlab.com/sacha-sokoloski/goal/-/blob/2e8b8fd09c026426546459acb3c5ae252e57631e/core/test/Spec.hs">suite of unit tests</a> for the functions in <code>Core</code>. The suite caught errors that were missed by the type system (I used Hasktorch&rsquo;s untyped API), such as vector shape errors, and conflating CPU and CUDA tensors. A few functions in <code>Core</code> internally use Hasktorch factory functions which create tensors on the CPU by default, so the test suite was particularly helpful in identifying the functions with these errors.
</p>
</div>
</div>
</div>
<div id="outline-container-org7a17b4e" class="outline-3">
<h3 id="org7a17b4e"><span class="section-number-3">2.3.</span> Goal Geometry</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-org8c31ca8" class="outline-4">
<h4 id="org8c31ca8"><span class="section-number-4">2.3.1.</span> Runtime exceptions</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
The runtime exceptions due to the mixing or CPU and CUDA tensors was resolved, but we decided to add another type parameter for the device on which a tensor is initialized. As a result, the syntax was not as clean, but the type safety is probably worth it. The unit test suite picked up some new errors after this change - certain data types are not supported for all operations on the GPU. For example, matrix multiplication only works with floating types. <code>Goal</code> only uses floating types with <code>Point=s on a =Manifold</code>, so this wouldn&rsquo;t present any problems, but one possible way of conditionally constraining data types depending on the device follows:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #b877db;">type</span> <span style="color: #b877db;">CUDANotSupportedError</span> (b <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Type</span>) <span style="color: #c7c9cb;">=</span>
    '<span style="color: #b877db;">Text</span> <span style="color: #fab795;">"You attempted to use "</span> '<span style="color: #b877db;">:&lt;&gt;:</span> '<span style="color: #b877db;">ShowType</span> b '<span style="color: #b877db;">:$$:</span>
    '<span style="color: #b877db;">Text</span> <span style="color: #fab795;">"which is not supported on CUDA"</span>

<span style="color: #b877db;">type</span> <span style="color: #b877db;">CUDASupportedTypes</span> <span style="color: #c7c9cb;">=</span> [<span style="color: #b877db;">Float</span>, <span style="color: #b877db;">Double</span>]

<span style="color: #b877db;">type</span> <span style="color: #b877db;">family</span> <span style="color: #b877db;">ValidType</span> (a <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">DeviceType</span>) (b <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Type</span>) <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Constraint</span> <span style="color: #b877db;">where</span>
    <span style="color: #fab795;">ValidType</span> '<span style="color: #fab795;">CPU</span> b <span style="color: #c7c9cb;">=</span> <span style="color: #fab795;">()</span>
    <span style="color: #fab795;">ValidType</span> '<span style="color: #fab795;">CUDA</span> b <span style="color: #c7c9cb;">=</span>
        <span style="color: #fab795;">TypeError</span> (<span style="color: #fab795;">CUDANotSupportedError</span> b) ('<span style="color: #fab795;">True</span> <span style="color: #c7c9cb;">~</span> <span style="color: #fab795;">Elem</span> b <span style="color: #fab795;">CUDASupportedTypes</span>)

<span style="color: #b877db;">type</span> <span style="color: #b877db;">family</span> <span style="color: #b877db;">Elem</span> (e <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Type</span>) (es <span style="color: #c7c9cb;">::</span> [<span style="color: #b877db;">Type</span>]) <span style="color: #b877db;">where</span>
    <span style="color: #fab795;">Elem</span> e '<span style="color: #fab795;">[]</span> <span style="color: #c7c9cb;">=</span> '<span style="color: #fab795;">False</span>
    <span style="color: #fab795;">Elem</span> e (e <span style="color: #fab795;">:</span> es) <span style="color: #c7c9cb;">=</span> '<span style="color: #fab795;">True</span>
    <span style="color: #fab795;">Elem</span> e (<span style="color: #b877db;">_</span> <span style="color: #fab795;">:</span> es) <span style="color: #c7c9cb;">=</span> <span style="color: #fab795;">Elem</span> e es
</pre>
</div>
<p>
The above includes a helpful error message if someone were to use an unsupported type.
</p>
</div>
</div>

<div id="outline-container-org98517d7" class="outline-4">
<h4 id="org98517d7"><span class="section-number-4">2.3.2.</span> Benchmarks</h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
After propagating the hasktorch primitives through the Geometry package, I ran some benchmarks comparing the original goal backend to both the CPU and CUDA based hasktorch backends. There isn&rsquo;t a large difference between the CPU performance, but the GPU shows a substantial performance boost across the board.
</p>

<iframe width="900" height="1600" src="inversion.html" title="profiling"></iframe>
</div>
</div>

<div id="outline-container-org84dbab7" class="outline-4">
<h4 id="org84dbab7"><span class="section-number-4">2.3.3.</span> Profiling</h4>
<div class="outline-text-4" id="text-2-3-3">
<p>
After implementing most of the code in <code>goal-graphical</code>, I was able to profile the <a href="https://gitlab.com/sacha-sokoloski/goal/-/blob/a9dde905ab739ba314075fb1364fece32b3099b6/scripts/gradient-descent/gradient-descent-hasktorch.hs">gradient-descent script</a>. I discovered that there was a serious flaw in my implementation of <code>l2Norm</code>:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #87ceeb;">l2Norm</span>
    <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">forall</span> k d<span style="color: #c7c9cb;">.</span> (<span style="color: #b877db;">KnownNat</span> k, <span style="color: #b877db;">HasTensorOptions</span> <span style="color: #b877db;">Double</span> d)
    <span style="color: #c7c9cb;">=&gt;</span> <span style="color: #b877db;">Vector</span> k <span style="color: #b877db;">Double</span> d
    <span style="color: #c7c9cb;">-&gt;</span> <span style="color: #b877db;">Double</span>
<span style="color: #87ceeb;">l2Norm</span> <span style="color: #c7c9cb;">=</span> asValue <span style="color: #c7c9cb;">.</span> Torch.sqrt <span style="color: #c7c9cb;">.</span> (<span style="color: #c7c9cb;">*</span> fromIntegral k) <span style="color: #c7c9cb;">.</span> mseLoss (zeros [k] opts) <span style="color: #c7c9cb;">.</span> toTorch
    <span style="color: #b877db;">where</span> k <span style="color: #c7c9cb;">=</span> natValInt (<span style="color: #fab795;">Proxy</span> <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Proxy</span> k)
          opts <span style="color: #c7c9cb;">=</span> tensorOpts (<span style="color: #fab795;">Proxy</span> <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Proxy</span> <span style="color: #b877db;">Double</span>) (<span style="color: #fab795;">Proxy</span> <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Proxy</span> d)
</pre>
</div>

<p>
In the above code, I create a (non-sparse) tensor of zeros to use with Hasktorch&rsquo;s <code>mseLoss</code> function. Allocating this memory is not necessary, however, as I can compute the <code>l2Norm</code> more directly:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #87ceeb;">l2Norm</span>
    <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">forall</span> k d<span style="color: #c7c9cb;">.</span> (<span style="color: #b877db;">KnownNat</span> k)
    <span style="color: #c7c9cb;">=&gt;</span> <span style="color: #b877db;">Vector</span> k <span style="color: #b877db;">Double</span> d
    <span style="color: #c7c9cb;">-&gt;</span> <span style="color: #b877db;">Double</span>
<span style="color: #87ceeb;">l2Norm</span> <span style="color: #c7c9cb;">=</span> asValue <span style="color: #c7c9cb;">.</span> Torch.sqrt <span style="color: #c7c9cb;">.</span> sumAll <span style="color: #c7c9cb;">.</span> pow (<span style="color: #f09383; font-weight: bold;">2</span> <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">Int</span>) <span style="color: #c7c9cb;">.</span> toTorch
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org52df0ea" class="outline-3">
<h3 id="org52df0ea"><span class="section-number-3">2.4.</span> Goal Probability</h3>
<div class="outline-text-3" id="text-2-4">
<p>
This was the most challenging goal package to implement, and several outstanding issues remain. One problem is that a neural network using the hasktorch backend does not learn at all if there are multiple neurons in a layer. It does, however, learn if there is only a single neuron - essentially a logistic regression. This suggests a bug in the implementation of <code>Replicated Manifold</code> s. There may be an incorrect reshaping operation where a <code>Vector</code> is not constructed in row major order. I was not able to diagnose the problem after nearly a week of troubleshooting, so I proceeded to benchmarking and profiling.
</p>
</div>

<div id="outline-container-org4fa9587" class="outline-4">
<h4 id="org4fa9587"><span class="section-number-4">2.4.1.</span> Random tensors</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
I <a href="https://gitlab.com/sacha-sokoloski/goal/-/blob/b6fa159574f2fc67481e046b537b0cffe222d8d9/core/Goal/Core/Hasktorch/Random.hs">structured the code</a> to randomly generate tensors using <code>Hasktorch</code> instead of <code>RandomMWC</code>. For example, the following generates a <code>Vector</code> of Bernoulli random variables:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #87ceeb;">bernoulli</span>
  <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">forall</span> n d <span style="color: #c7c9cb;">.</span> (<span style="color: #b877db;">KnownNat</span> n, <span style="color: #b877db;">HasTensorOptions</span> <span style="color: #b877db;">Double</span> d)
  <span style="color: #c7c9cb;">=&gt;</span> <span style="color: #b877db;">Double</span>
  <span style="color: #c7c9cb;">-&gt;</span> <span style="color: #b877db;">State</span> <span style="color: #b877db;">Generator</span> (<span style="color: #b877db;">Vector</span> n <span style="color: #b877db;">Bool</span> d)
<span style="color: #87ceeb;">bernoulli</span> p <span style="color: #c7c9cb;">=</span> <span style="color: #b877db;">do</span>
  v <span style="color: #c7c9cb;">&lt;-</span> state T.randomUniformVector <span style="color: #c7c9cb;">::</span> <span style="color: #b877db;">State</span> <span style="color: #b877db;">Generator</span> (<span style="color: #b877db;">Vector</span> n <span style="color: #b877db;">Double</span> d)
  pure <span style="color: #c7c9cb;">$</span> T.lessThan v p
</pre>
</div>

<p>
The implementation of <a href="https://gitlab.com/sacha-sokoloski/goal/-/blob/a9dde905ab739ba314075fb1364fece32b3099b6/probability/Goal/Probability/Hasktorch/Statistical.hs#L58">Random</a> could be improved as it currently has an unused parameter.
</p>
</div>
</div>

<div id="outline-container-org70ac2ff" class="outline-4">
<h4 id="org70ac2ff"><span class="section-number-4">2.4.2.</span> Runtime exceptions</h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
I debugged the runtime exceptions here with <code>ghc-debug</code> by running <code>:set -fbreak-on-error</code> in a repl, followed by <code>:trace</code>. This was an enormous help, although it did take some getting used to.
</p>

<p>
The first exception arose due to a faulty implementation of <code>fromInteger</code> in the <code>Num</code> instance of <code>Vector</code>. I originally used a stock deriving strategy to define the <code>Num</code> instance for <code>Vector</code>. This would produce a size 0 tensor when casting an integer to a <code>Vector</code>, whereas the <a href="https://gitlab.com/sacha-sokoloski/goal/-/commit/ebd9ad1be3e9114cde52c1c105c1350ff6370e70">correct behavior</a> is to generate a <code>Vector</code> with <code>n</code> replicated integers, where <code>n</code> is the size of the <code>Vector</code>.
</p>

<p>
The second exception was due to a faulty implementation of <code>lowerTriangular</code> in <code>Core</code>. The <a href="https://gitlab.com/sacha-sokoloski/goal/-/commit/2e8b8fd09c026426546459acb3c5ae252e57631e">fix</a> involved correctly masking the triangular elements.
</p>
</div>
</div>
<div id="outline-container-org3bab85a" class="outline-4">
<h4 id="org3bab85a"><span class="section-number-4">2.4.3.</span> Benchmarks</h4>
<div class="outline-text-4" id="text-2-4-3">
<p>
The plan was to benchmark backpropagation, but instead I only benchmarked the forward pass.
</p>

<iframe width="900" height="1600" src="backprop.html" title="profiling"></iframe>

<p>
The performance is substantially worse using the hasktorch backend, which is suprising given that a forward pass is essentially a series of simple matrix operations. The problem may lie with the <a href="https://gitlab.com/sacha-sokoloski/goal/-/blob/a9dde905ab739ba314075fb1364fece32b3099b6/geometry/Goal/Geometry/Hasktorch/Map/Linear.hs#L283">&gt;$&gt;</a> which is basically a wrapper for the <a href="https://gitlab.com/sacha-sokoloski/goal/-/blob/a9dde905ab739ba314075fb1364fece32b3099b6/core/Goal/Core/Hasktorch/Vector.hs#L593-604">matrixMap</a> and similar functions. This function takes a list of <code>Vector=s and performs the =map</code> operation as a matrix multiplication. The resulting matrix is split into a list of <code>Vector</code> s which may not be very efficient, so once more we turn to profiling.
</p>
</div>
</div>
<div id="outline-container-org4cb3430" class="outline-4">
<h4 id="org4cb3430"><span class="section-number-4">2.4.4.</span> Profiling</h4>
<div class="outline-text-4" id="text-2-4-4">
<p>
Unlike in <code>Goal Geometry</code> where it was easy to identity a single function (<code>l2Norm</code>) that had poor performance, here an obvious bottleneck was harder for me to identity.
</p>

<p>
<b>Hasktorch CPU backend</b>
</p>

<p>
There are calls to <code>retryWithGC'</code> each time a Hasktorch tensor is used, which seems to indicate that memory allocation is failing for some reason.
</p>
<iframe width="1200" height="294" src="hasktorch-goal.svg" title="profiling"></iframe>

<p>
<b>Hasktorch CUDA backend</b>
</p>

<p>
The CUDA backend shows the same problem. I don&rsquo;t have a good enough grasp on the low level details of Haskell to analyze this further at this time, but it&rsquo;s something I shall to return to soon.
</p>
<iframe width="1200" height="294" src="hasktorch-goal-cuda.svg" title="profiling"></iframe>

<p>
What&rsquo;s clear is that performing the matrix operations involved in the forward pass directly have good performance, but my implementation suffers from severe performance loss. One possible solution may be to avoid using lists and pass around tensors directly, similarly to how =Replicated Manifold=s are handled.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf115300" class="outline-2">
<h2 id="orgf115300"><span class="section-number-2">3.</span> Future Work</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>There are a few functions that have yet to be implemented in <code>Goal Core</code>, such as <code>pseudo inverse</code></li>
<li>The logic error in the implementation of neural networks should be fixed</li>
<li>Diagnose the performance issues in the forward pass with more thorough profiling</li>
<li>Rewrite the code to resolve the performance issues</li>
<li>Check if the problem persists with <code>backpropagation</code>, and if so, address it</li>
<li>Developer setup
<ol class="org-ol">
<li>Use nix to provide a developer environment for Goal, similar to the template Hasktorch provides.</li>
<li>Cache the Hasktorch build artifacts in docker to dramatically reduce build times.</li>
</ol></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Zarak Mahmud</p>
<p class="date">Created: 2022-09-11 Sun 19:10</p>
</div>
</body>
</html>
